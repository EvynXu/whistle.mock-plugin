# 处理@格式规则和透传问题

## 问题描述

当使用`@https://www.baidu.com/`这样的规则时，请求未能正确透传到目标URL，而是返回404错误。

## 问题原因

1. Whistle插件对以`@`开头的规则处理逻辑不完善
2. 原始URL解析顺序不合理，未优先处理规则值
3. 转发机制未正确处理直接外部URL请求

## 修复方案

### 1. 增强parseOriginalUrl函数

修改了URL解析逻辑，优先处理以`@`开头的规则：
- 首先检查规则值是否以`@`开头
- 如果是，直接提取后面的URL作为目标URL
- 优化了原始URL解析的顺序

### 2. 增强主处理中间件

在app.use中间件中添加了专门针对`@`格式规则的处理逻辑：
- 在规则管理器处理前检查是否为`@`格式规则
- 对`@`格式规则直接设置转发URL并继续请求链
- 记录转发信息到日志系统

### 3. 优化handleLegacyRequest函数

改进了对不同URL格式的处理：
- 区分HTTP、其他协议和相对路径格式
- 针对不同格式使用不同的处理策略
- 优化日志记录，更清晰地展示处理过程

## 使用方法

现在可以使用以下格式的规则进行直接透传：

```
example.com whistle.mock-plugin://@https://target.com/api
```

或者在Whistle管理界面中添加规则：

```
example.com whistle.mock-plugin://
```

然后在访问URL时使用：

```
http://example.com/@https://www.baidu.com/
```

## 验证方法

1. 在Whistle中添加规则：
   ```
   test.com whistle.mock-plugin://
   ```

2. 访问以下URL测试@格式规则：
   ```
   http://test.com/@https://www.baidu.com/
   ```

3. 应该能够成功访问百度，而不是返回404错误

## 注意事项

1. @格式规则优先级最高，会绕过常规的接口匹配逻辑
2. 所有透传请求都会在日志中记录，便于排查问题
3. 此功能主要用于调试和特殊场景，建议谨慎使用 